# Exercise 3: Grafana Dashboard Configuration
# =============================================
#
# Duration: 15 minutes | TODOs: 6
#
# What you'll learn:
# - Grafana datasource configuration
# - Dashboard JSON structure
# - PromQL queries for panels
#
# Instructions:
# Fill in the 6 TODOs marked with '????' or '# YOUR CODE HERE'
# Each TODO has inline hints showing exactly what to use.

---
# ConfigMap: Grafana Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  labels:
    app: grafana

data:
  grafana.ini: |
    [server]
    root_url = http://localhost:3000

    [analytics]
    check_for_updates = false
    reporting_enabled = false

    # TODO 1: Enable anonymous access (for workshop only!)
    # HINT: Set enabled = true and org_role = Viewer
    [auth.anonymous]
    enabled = ????      # YOUR CODE HERE (true or false)
    org_role = ????     # YOUR CODE HERE (Viewer, Editor, or Admin)

    [security]
    admin_user = admin
    admin_password = admin

---
# ConfigMap: Prometheus Datasource
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  labels:
    app: grafana

data:
  prometheus.yaml: |
    apiVersion: 1

    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      # TODO 2: Set Prometheus URL
      # HINT: Use the Kubernetes service name: http://prometheus:9090
      url: ????  # YOUR CODE HERE

      isDefault: true
      editable: false
      jsonData:
        timeInterval: 15s

---
# ConfigMap: Dashboard Provider
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-providers
  labels:
    app: grafana

data:
  dashboards.yaml: |
    apiVersion: 1

    providers:
    - name: 'MLOps Dashboards'
      orgId: 1
      folder: 'MLOps Workshop'
      type: file
      disableDeletion: false
      editable: true
      options:
        path: /var/lib/grafana/dashboards

---
# ConfigMap: MLOps Dashboard
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-mlops
  labels:
    app: grafana

data:
  mlops-overview.json: |
    {
      "uid": "mlops-overview",
      "title": "MLOps Overview",
      "tags": ["mlops", "workshop"],
      "timezone": "browser",
      "schemaVersion": 16,
      "version": 1,
      "refresh": "10s",

      "panels": [
          {
            "id": 1,
            "title": "Request Rate (req/sec)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(gateway_http_requests_total[5m])) by (endpoint)",
                "legendFormat": "{{endpoint}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "reqps", "label": "Requests/sec"},
              {"format": "short"}
            ]
          },

          {
            "id": 2,
            "title": "Error Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                // TODO 3: Write PromQL for 4xx error rate
                // HINT: rate(gateway_http_requests_total{status=~"4.."}[5m])
                "expr": "????",  # YOUR CODE HERE
                "legendFormat": "4xx errors",
                "refId": "A"
              },
              {
                "expr": "rate(gateway_http_requests_total{status=~\"5..\"}[5m])",
                "legendFormat": "5xx errors",
                "refId": "B"
              }
            ],
            "yaxes": [
              {"format": "reqps", "label": "Errors/sec"},
              {"format": "short"}
            ],
            "alert": {
              "conditions": [
                {
                  "evaluator": {"type": "gt", "params": [0.05]},
                  "query": {"params": ["B", "5m", "now"]}
                }
              ]
            }
          },

          {
            "id": 3,
            "title": "Gateway Latency (P95, P99)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [
              {
                // TODO 4: Write PromQL for P95 latency
                // HINT: histogram_quantile(0.95, sum by (le) (rate(gateway_http_request_duration_seconds_bucket[5m])))
                "expr": "????",  # YOUR CODE HERE
                "legendFormat": "P95",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.99, sum by (le) (rate(gateway_http_request_duration_seconds_bucket[5m])))",
                "legendFormat": "P99",
                "refId": "B"
              }
            ],
            "yaxes": [
              {"format": "s", "label": "Latency"},
              {"format": "short"}
            ]
          },

          {
            "id": 4,
            "title": "ML Inference Latency (P95)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
            "targets": [
              {
                // TODO 5: Write PromQL for ML backend P95 latency
                // HINT: Similar to TODO 4, but change "gateway_http_request_duration" to "gateway_backend_request_duration"
                "expr": "????",  # YOUR CODE HERE
                "legendFormat": "ML Service P95",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "s", "label": "Latency"},
              {"format": "short"}
            ],
            "thresholds": [
              {
                "value": 2.0,
                "colorMode": "critical",
                "fill": true,
                "line": true
              }
            ]
          },

          {
            "id": 5,
            "title": "Pod Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "targets": [
              {
                "expr": "container_memory_usage_bytes{pod=~\"api-gateway.*|sentiment-api.*\"}",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "bytes", "label": "Memory"},
              {"format": "short"}
            ]
          },

          {
            "id": 6,
            "title": "Pod CPU Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{pod=~\"api-gateway.*|sentiment-api.*\"}[5m])",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "percentunit", "label": "CPU Cores"},
              {"format": "short"}
            ]
          }
      ]
    }

---
# Deployment: Grafana
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:10.2.2

        ports:
        - containerPort: 3000
          name: web

        volumeMounts:
        - name: config
          mountPath: /etc/grafana
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: dashboards-config
          mountPath: /etc/grafana/provisioning/dashboards
        - name: dashboards
          mountPath: /var/lib/grafana/dashboards
        - name: data
          mountPath: /var/lib/grafana

        env:
        - name: GF_SECURITY_ADMIN_USER
          value: admin
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: admin

        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 200m
            memory: 512Mi

      volumes:
      - name: config
        configMap:
          name: grafana-config
      - name: datasources
        configMap:
          name: grafana-datasources
      - name: dashboards-config
        configMap:
          name: grafana-dashboard-providers
      - name: dashboards
        configMap:
          name: grafana-dashboard-mlops
      - name: data
        emptyDir: {}

---
# Service: Grafana UI
apiVersion: v1
kind: Service
metadata:
  name: grafana
  labels:
    app: grafana
spec:
  type: NodePort
  selector:
    app: grafana
  ports:
  - name: web
    port: 3000
    targetPort: 3000
    # TODO 6: Set NodePort for accessing Grafana
    # HINT: Use port 30300 (will be accessible at http://localhost:30300 in kind)
    nodePort: ????  # YOUR CODE HERE

# =============================================================================
# KEY CONCEPTS
# =============================================================================
#
# 1. GRAFANA ARCHITECTURE
#    - Datasources: Where to fetch data (Prometheus, InfluxDB, etc.)
#    - Dashboards: Collections of panels
#    - Panels: Individual graphs/visualizations
#    - Provisioning: Auto-configure via YAML/JSON files
#
# 2. DASHBOARD JSON STRUCTURE
#    - dashboard.title: Dashboard name
#    - dashboard.panels: Array of visualization panels
#    - panel.targets: PromQL queries for data
#    - panel.gridPos: Position and size {x, y, w, h}
#
# 3. PANEL TYPES
#    - graph: Time series line chart
#    - stat: Single number with sparkline
#    - gauge: Progress bar/gauge
#    - table: Tabular data
#    - heatmap: Color-coded matrix
#
# 4. PROMQL IN GRAFANA
#    - expr: The Prometheus query
#    - legendFormat: Legend label (use {{label}} for variables)
#    - refId: Unique identifier for multi-query panels
#
# 5. YAXIS FORMATS
#    - bytes: B, KB, MB, GB
#    - s: Seconds
#    - reqps: Requests per second
#    - percentunit: 0.0-1.0 displayed as %
#    - short: Auto-format with SI prefixes
#
# 6. DASHBOARD PROVISIONING
#    - dashboards.yaml: Tells Grafana where to find dashboards
#    - JSON files: Actual dashboard definitions
#    - path: Directory containing JSON files
#    - Grafana auto-loads on startup
#
# =============================================================================
# COMMON PROMQL PATTERNS FOR DASHBOARDS
# =============================================================================
#
# REQUEST RATE:
#   sum(rate(metric[5m])) by (label)
#
# ERROR RATE:
#   sum(rate(metric{status=~"5.."}[5m]))
#
# LATENCY PERCENTILES:
#   histogram_quantile(0.95, sum by (le) (rate(metric_bucket[5m])))
#
# MEMORY USAGE:
#   container_memory_usage_bytes{pod=~"pattern.*"}
#
# CPU USAGE:
#   rate(container_cpu_usage_seconds_total{pod=~"pattern.*"}[5m])
#
# SUCCESS RATE:
#   sum(rate(metric{status=~"2.."}[5m]))
#   / sum(rate(metric[5m])) * 100
#
# =============================================================================
# TESTING THE DASHBOARD
# =============================================================================
#
# 1. DEPLOY GRAFANA:
#    kubectl apply -f grafana-dashboard.yaml
#    kubectl wait --for=condition=ready pod -l app=grafana --timeout=120s
#
# 2. ACCESS UI:
#    # Option A: NodePort (kind)
#    open http://localhost:30300
#
#    # Option B: Port-forward
#    kubectl port-forward svc/grafana 3000:3000
#    open http://localhost:3000
#
# 3. LOGIN:
#    Username: admin
#    Password: admin
#
# 4. NAVIGATE TO DASHBOARD:
#    Dashboards → MLOps Workshop → MLOps Overview
#
# 5. VERIFY PANELS:
#    - 6 panels should load
#    - Data should appear (if services are running and generating traffic)
#    - No "No Data" errors
#
# 6. GENERATE TRAFFIC FOR DATA:
#    kubectl port-forward svc/api-gateway-service 8080:80
#    for i in {1..100}; do
#      curl -X POST http://localhost:8080/predict \
#           -H "Content-Type: application/json" \
#           -d '{"request": {"text": "Production ready!","request_id": null}}' &
#    done
#
# 7. WATCH METRICS UPDATE:
#    - Request rate increases
#    - Latency panels update
#    - Resource usage visible
#
# =============================================================================
# CUSTOMIZING DASHBOARDS
# =============================================================================
#
# Edit in UI:
# 1. Click panel title → Edit
# 2. Modify query, visualization, thresholds
# 3. Click Apply
# 4. Save dashboard
#
# Note: Changes lost on pod restart (dashboard is provisioned)
#
# To persist changes:
# 1. Edit in UI
# 2. Dashboard settings → JSON Model → Copy
# 3. Update this ConfigMap's JSON
# 4. kubectl apply -f grafana-dashboard.yaml
# 5. kubectl rollout restart deployment/grafana
#
# =============================================================================
# VALIDATION
# =============================================================================
#
# Run validation tests:
#   ./tests/test_grafana.sh
#
# Manual checks:
#   1. kubectl get pods -l app=grafana
#   2. kubectl logs -l app=grafana | grep "HTTP Server Listen"
#   3. Open http://localhost:30300
#   4. Navigate to dashboard
#   5. Verify 6 panels load without errors
#
# =============================================================================
